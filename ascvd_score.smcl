{smcl}
{com}{sf}{ul off}{txt}{.-}
      name:  {res}<unnamed>
       {txt}log:  {res}X:/OneDrive - The University of the West Indies/repo_datagroup/repo_p120\ascvd_score.smcl
  {txt}log type:  {res}smcl
 {txt}opened on:  {res}26 Mar 2019, 07:02:01
{txt}
{com}. ** HEADER -----------------------------------------------------
. 
. ** SOURCE       
. **                      Goff DC Jr, Lloyd-Jones DM, Bennett G, Coady S, D’Agostino RB Sr,
. **                      Gibbons R, Greenland P, Lackland DT, Levy D, O’Donnell CJ, Robinson JG,
. **                      Schwartz JS, Shero ST, Smith SC Jr, Sorlie P, Stone NJ, Wilson PWF. 2013 ACC/
. **                      AHA guideline on the assessment of cardiovascular risk: a report of the American
. **                      College of Cardiology/American Heart Association Task Force on Practice
. **                      Guidelines. J Am Coll Cardiol 2014;63:2935–59.
. **
. **                      Copies: This document is available on the World Wide Web sites of the American
. **                      College of Cardiology (www.cardiosource.org), and the American Heart Association
. **                      (http://my.americanheart.org).
. 
. ** Health of the Nation as example
. use "`datapath'/version01/1-input/hotn_v41RPAQ", clear
{txt}(HotN v41 - Prepared by IRH)

{com}. 
. ** Apply weighting
. svyset ed [pweight=wfinal1_ad], strata(region)

      {txt}pweight:{col 16}{res}wfinal1_ad
          {txt}VCE:{col 16}{res}linearized
  {txt}Single unit:{col 16}{res}missing
     {txt}Strata 1:{col 16}{res}region
         {txt}SU 1:{col 16}{res}ed
        {txt}FPC 1:{col 16}<zero>
{p2colreset}{...}

{com}. 
. ** Risk factor calculations - systolic blood pressure and diastolic blood presure
. gen avgsbp = ( sbp2 + sbp3 ) / 2 
{txt}(3 missing values generated)

{com}. label variable avgsbp "Average Systolic blood pressure"
{txt}
{com}. gen avgdbp = ( dbp2 + dbp3 ) / 2 
{txt}(3 missing values generated)

{com}. label variable avgdbp "Average diastolic blood pressure"
{txt}
{com}. 
. ** Convert TCHOL         mmol/l --> mg/dL
. gen tchol_mg = tchol * 38.67
{txt}(119 missing values generated)

{com}. label var tchol_mg "Total cholesterol (mg/dL)"
{txt}
{com}. 
. ** Convert HDL   mmol/l --> mg/dL
. gen hdl_mg = hdl * 38.67
{txt}(119 missing values generated)

{com}. label var hdl_mg "HDL (mg/dL)"
{txt}
{com}. 
. ** -----------------------------------------------------------
. ** Ten year survial - ASCVD equation
. **
. ** Calculating the 10-year risk estimate for hard ASCVD can best be described in a series of steps. 
. ** (1)  The natural log of age, total cholesterol, HDL-C, and systolic BP are first calculated \
. **              with systolic BP being either a treated or untreated value. 
. ** (2)  Any appropriate interaction terms are then calculated. 
. ** (3)  These values are then multiplied by the coefficients from the equation (“Coefficient” column of Table A) 
. **              for the specific race-sex group of the individual. The “Coefficient % Value” column in the table
. **              provides the results of the multiplication for the risk profile described above.
. ** (4)  The sum of the “Coefficient % Value” column is then calculated for the individual. 
. **              For the profile shown in Table A, this value is shown as “Individual Sum” for each race and sex group.
. ** (5)  The estimated 10-year risk of a first hard ASCVD event is formally calculated as 
. **              1 minus the survival rate at 10 years (“Baseline Survival” in Table A), raised to the
. **              power of the exponent of the “Coefficient % Value” sum minus the race- and sex-specific 
. **              overall mean “Coefficient % Value” sum; or, in equation form:
. **
. **              1 - S10^e(indXB - MeanXB)
. ** -----------------------------------------------------------
. 
. 
. ** -----------------------------------------------------------
. ** African Descent Women (sex==1)
. ** -----------------------------------------------------------
. 
. ** Model Terms
. 
. ** ln Age (y)
. gen lnage = ln(agey)
{txt}
{com}. gen coeflnage = (lnage)*(17.114) if sex == 1 
{txt}(470 missing values generated)

{com}. 
. ** Ln Total Cholesterol (mg/dL)
. gen lntchol = ln(tchol_mg)
{txt}(119 missing values generated)

{com}. gen coeflntchol = (lntchol)*(0.940) if sex == 1 
{txt}(544 missing values generated)

{com}. 
. ** Ln HDL-C (mg/dL)
. gen lnhdl = ln(hdl_mg)
{txt}(119 missing values generated)

{com}. gen coeflnhdl = (lnhdl)*(-18.92) if sex == 1 
{txt}(544 missing values generated)

{com}. 
. ** Ln Age x Ln HDL-C
. gen interact1 = 0 
{txt}
{com}. replace interact1 = 4.475 * lnage * lnhdl if sex == 1
{txt}(764 real changes made, 74 to missing)

{com}. 
. ** Ln Treated Systolic BP (mm Hg)
. gen lnsbpt = ln(avgsbp)
{txt}(3 missing values generated)

{com}. gen coeflnsbpt = (lnsbpt)*(29.291) if sex == 1 & hyperm == 1
{txt}(974 missing values generated)

{com}. 
. ** Ln Untreated Systolic BP (mm Hg)
. gen lnsbput = ln(avgsbp)
{txt}(3 missing values generated)

{com}. gen coeflnsbput = (lnsbput)*(27.82) if sex == 1 & (hyperm == 2 | hyperm==.z)
{txt}(733 missing values generated)

{com}. 
. ** Single variable for Ln SBP (treated or untreated as appropriate)
. gen coeflnsbp = 0 
{txt}
{com}. replace coeflnsbp = coeflnsbpt if sex==1 & hyperm == 1
{txt}(260 real changes made)

{com}. replace coeflnsbp = coeflnsbput if sex==1 & (hyperm == 2 | hyperm==.z)
{txt}(504 real changes made, 3 to missing)

{com}. 
. ** Ln Age % Ln Treated Systolic BP
. gen interact2 = 0
{txt}
{com}. replace interact2 = -6.432 * lnage * lnsbpt if sex == 1 & hyperm==1
{txt}(260 real changes made)

{com}. 
. ** Ln Age % Ln Untreated Systolic BP
. gen interact3 = 0
{txt}
{com}. replace interact3 = -6.087 * lnage * lnsbput if sex == 1 & (hyperm == 2 | hyperm==.z)
{txt}(504 real changes made, 3 to missing)

{com}. 
. ** Current Smoker (1=Yes, 0=No)
. recode smoke 2 = 0
{txt}(smoke: 1141 changes made)

{com}. gen smokeeq = 0
{txt}
{com}. replace smokeeq = 0.691 * smoke  if sex == 1 
{txt}(28 real changes made)

{com}. 
. ** Diabetes (1=Yes, 0=No)
. recode diab 2 = 0
{txt}(diab: 1029 changes made)

{com}. gen diabeq = 0
{txt}
{com}. replace diabeq = 0.874 * diab if sex == 1
{txt}(135 real changes made)

{com}. 
. 
. 
. ** -----------------------------------------------------------
. ** African Descent Men (sex=2)
. ** -----------------------------------------------------------
. replace coeflnage  = (lnage)*(2.469) if sex == 2
{txt}(470 real changes made)

{com}. replace coeflntchol  = (lntchol)*(0.302) if sex == 2
{txt}(425 real changes made)

{com}. replace coeflnhdl  = (lnhdl)*(-0.307) if sex == 2
{txt}(425 real changes made)

{com}. replace coeflnsbpt  = (lnsbpt)*(1.916) if sex == 2 & hyperm == 1
{txt}(107 real changes made)

{com}. replace coeflnsbput  = (lnsbput)*(1.809) if sex == 2 & (hyperm == 2 | hyperm==.z)
{txt}(363 real changes made)

{com}.         replace coeflnsbp = coeflnsbpt if sex==2 & hyperm == 1
{txt}(107 real changes made)

{com}.         replace coeflnsbp = coeflnsbput if sex==2 & (hyperm == 2 | hyperm==.z)
{txt}(363 real changes made)

{com}. replace smokeeq = 0.549 * smoke if sex == 2
{txt}(65 real changes made)

{com}. replace diabeq = 0.645 * diab if sex == 2
{txt}(70 real changes made, 1 to missing)

{com}. 
. ** Summation of the included terms for women or men
. gen add = coeflnage + coeflntchol + coeflnhdl + coeflnsbp + smokeeq + diabeq + interact1 + interact2 + interact3 
{txt}(123 missing values generated)

{com}. label var add "Summation of individual score items"
{txt}
{com}. 
. ** Sex-specific average summation
. sum add if sex ==1

{txt}    Variable {c |}        Obs        Mean    Std. Dev.       Min        Max
{hline 13}{c +}{hline 57}
{space 9}add {c |}{res}        687     86.4008    1.792276   80.36195   90.77576
{txt}
{com}. local meanf = r(mean)
{txt}
{com}. dis `meanf'
{res}86.400797
{txt}
{com}. sum add if sex ==2

{txt}    Variable {c |}        Obs        Mean    Std. Dev.       Min        Max
{hline 13}{c +}{hline 57}
{space 9}add {c |}{res}        424    19.35201    1.023557   17.10684   21.71398
{txt}
{com}. local meanm = r(mean)
{txt}
{com}. dis `meanm'
{res}19.35201
{txt}
{com}. 
. ** 10-year risk score
. gen tyr = 1 - 0.8954 ^ exp(add - `meanm') if sex == 2           
{txt}(810 missing values generated)

{com}. replace tyr = 1 - 0.9533 ^ exp(add - `meanf') if sex == 1
{txt}(687 real changes made)

{com}. replace tyr = tyr * 100
{txt}(1,111 real changes made)

{com}. label var tyr "10-year CVD risk"
{txt}
{com}. 
. ** DATA CHECK: review the component scores for first N=20 participants
. qui {c -(}
{txt}
{com}. sort tyr 
{txt}
{com}. 
. ** Index plot (10-year score by participant ID number)
. ** Simple confirmation that calculated risk for all participants contained within 0 and 100 (!)
. ** Color coded by sex (1=female, 2=male)
. gr twoway (scatter tyr pid if sex==1, mc(red)) (scatter tyr pid if sex==2, mc(blue)), legend(lab(1 "women") lab(2 "men"))
{res}{txt}
{com}. 
. 
. ** Keep only what we need in a new dataset
. keep pid sex agey tchol_mg hdl_mg avgsbp smoke diab add tyr mi stroke hf
{txt}
{com}. order pid sex agey tchol_mg hdl_mg avgsbp smoke diab add tyr 
{txt}
{com}. label data "ACC/AHA 10-year CVD risk in HOTN"
{txt}
{com}. save "`datapath'/version01/2-working/cvd_risk_score.dta", replace
{txt}(note: file X:/The University of the West Indies/DataGroup - repo_data/data_p120/version01/2-working/cvd_risk_score.dta not found)
file X:/The University of the West Indies/DataGroup - repo_data/data_p120/version01/2-working/cvd_risk_score.dta saved

{com}. 
. ** Quintiles of 10-year risk
. xtile tyr_q = tyr , n(5) 
{txt}
{com}. table tyr_q, c(n tyr mean tyr sd tyr) format(%9.2f)

{txt}{hline 10}{c TT}{hline 35}
5         {c |}
quantiles {c |}
of tyr    {c |}     N(tyr)   mean(tyr)     sd(tyr)
{hline 10}{c +}{hline 35}
        1 {c |}        {res}223        0.85        0.58
        {txt}2 {c |}        {res}222        3.66        1.00
        {txt}3 {c |}        {res}222        8.08        1.69
        {txt}4 {c |}        {res}222       16.06        3.12
        {txt}5 {c |}        {res}222       37.00       14.16
{txt}{hline 10}{c BT}{hline 35}

{com}. 
. ** Binary stratification. (<20%) and (>=20%)
. gen tyr20 = 0
{txt}
{com}. replace tyr20 = 1 if tyr>=20
{txt}(382 real changes made)

{com}. replace tyr20 = . if mi==1 | stroke==1 | hf==1
{txt}(53 real changes made, 53 to missing)

{com}. 
. ** Brief tabulations to compare 
. tab tyr20 sex, col
{txt}
{c TLC}{hline 19}{c TRC}
{c |} Key{col 21}{c |}
{c LT}{hline 19}{c RT}
{c |}{space 5}{it:frequency}{col 21}{c |}
{c |}{space 1}{it:column percentage}{col 21}{c |}
{c BLC}{hline 19}{c BRC}

           {c |}    participant sex
     tyr20 {c |}    Female       Male {c |}     Total
{hline 11}{c +}{hline 22}{c +}{hline 10}
         0 {c |}{res}       526        303 {txt}{c |}{res}       829 
           {txt}{c |}{res}     72.25      66.89 {txt}{c |}{res}     70.19 
{txt}{hline 11}{c +}{hline 22}{c +}{hline 10}
         1 {c |}{res}       202        150 {txt}{c |}{res}       352 
           {txt}{c |}{res}     27.75      33.11 {txt}{c |}{res}     29.81 
{txt}{hline 11}{c +}{hline 22}{c +}{hline 10}
     Total {c |}{res}       728        453 {txt}{c |}{res}     1,181 
           {txt}{c |}{res}    100.00     100.00 {txt}{c |}{res}    100.00 
{txt}
{com}. tab tyr20 sex, col miss
{txt}
{c TLC}{hline 19}{c TRC}
{c |} Key{col 21}{c |}
{c LT}{hline 19}{c RT}
{c |}{space 5}{it:frequency}{col 21}{c |}
{c |}{space 1}{it:column percentage}{col 21}{c |}
{c BLC}{hline 19}{c BRC}

           {c |}    participant sex
     tyr20 {c |}    Female       Male {c |}     Total
{hline 11}{c +}{hline 22}{c +}{hline 10}
         0 {c |}{res}       526        303 {txt}{c |}{res}       829 
           {txt}{c |}{res}     68.85      64.47 {txt}{c |}{res}     67.18 
{txt}{hline 11}{c +}{hline 22}{c +}{hline 10}
         1 {c |}{res}       202        150 {txt}{c |}{res}       352 
           {txt}{c |}{res}     26.44      31.91 {txt}{c |}{res}     28.53 
{txt}{hline 11}{c +}{hline 22}{c +}{hline 10}
         . {c |}{res}        36         17 {txt}{c |}{res}        53 
           {txt}{c |}{res}      4.71       3.62 {txt}{c |}{res}      4.29 
{txt}{hline 11}{c +}{hline 22}{c +}{hline 10}
     Total {c |}{res}       764        470 {txt}{c |}{res}     1,234 
           {txt}{c |}{res}    100.00     100.00 {txt}{c |}{res}    100.00 
{txt}
{com}. 
{txt}end of do-file

{com}. do "X:\OneDrive - The University of the West Indies\repo_datagroup\repo_p120\who_score_amr_b.do"
{txt}
{com}. ** HEADER -----------------------------------------------------
. **  DO-FILE METADATA
.     //  algorithm name                                  who_score_amr_b.do
.     //  project:                                        Pediatric ECHORN (P-ECS)
.     //  analysts:                                       Ian HAMBLETON
.     //  date last modified          26-MAR-2019
.     //  algorithm task                      WHO CVD risk score. Americas. Region B.
. 
.     ** General algorithm set-up
.     version 15
{txt}
{com}.     clear all
{res}{txt}
{com}.     macro drop _all
{txt}
{com}.     set more 1
{txt}
{com}.     set linesize 80
{txt}
{com}. 
.     ** Set working directories: this is for DATASET and LOGFILE import and export
.     ** DATASETS to encrypted SharePoint folder
.     local datapath "X:/The University of the West Indies/DataGroup - repo_data/data_p120"
{txt}
{com}.     ** LOGFILES to unencrypted OneDrive folder (.gitignore set to IGNORE log files on PUSH to GitHub)
.     local logpath X:/OneDrive - The University of the West Indies/repo_datagroup/repo_p120
{txt}
{com}. 
.     ** Close any open log file and open a new log file
.     capture log close
{smcl}
{com}{sf}{ul off}